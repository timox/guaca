version: '3.8'

services:
  # Service PostgreSQL
  postgres:
    image: postgres:15-alpine
    container_name: guacamole-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DATABASE:-guacamole_db}
      POSTGRES_USER: ${POSTGRES_USER:-guacamole}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-guacamole_password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
      # Options PostgreSQL
      POSTGRES_MAX_CONNECTIONS: 200
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 1GB
      POSTGRES_MAINTENANCE_WORK_MEM: 64MB
      POSTGRES_CHECKPOINT_COMPLETION_TARGET: 0.9
      POSTGRES_WAL_BUFFERS: 16MB
      POSTGRES_DEFAULT_STATISTICS_TARGET: 100
      POSTGRES_RANDOM_PAGE_COST: 1.1
      POSTGRES_EFFECTIVE_IO_CONCURRENCY: 200
      POSTGRES_WORK_MEM: 4MB
      POSTGRES_MIN_WAL_SIZE: 1GB
      POSTGRES_MAX_WAL_SIZE: 4GB
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init:/docker-entrypoint-initdb.d:ro
    networks:
      - guacamole_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-guacamole}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Service Guacd
  guacd:
    image: guacamole/guacd:1.5.4
    container_name: guacamole-guacd
    restart: unless-stopped
    environment:
      GUACD_LOG_LEVEL: ${GUACD_LOG_LEVEL:-info}
    volumes:
      - guacd_drive:/drive:rw
      - guacd_record:/record:rw
    networks:
      - guacamole_network
    ports:
      - "4822:4822"

  # Service Guacamole
  guacamole:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        GUAC_VERSION: 1.5.4
    container_name: guacamole-web
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      guacd:
        condition: service_started
    environment:
      # Configuration de base
      GUACAMOLE_HOME: /etc/guacamole
      
      # Configuration PostgreSQL
      POSTGRES_HOSTNAME: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: ${POSTGRES_DATABASE:-guacamole_db}
      POSTGRES_USER: ${POSTGRES_USER:-guacamole}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-guacamole_password}
      POSTGRES_MAX_CONNECTIONS: ${POSTGRES_MAX_CONNECTIONS:-20}
      POSTGRES_MAX_IDLE_TIME: ${POSTGRES_MAX_IDLE_TIME:-600}
      POSTGRES_CONNECTION_TIMEOUT: ${POSTGRES_CONNECTION_TIMEOUT:-30}
      
      # Configuration LDAP (optionnel)
      LDAP_HOSTNAME: ${LDAP_HOSTNAME:-}
      LDAP_PORT: ${LDAP_PORT:-389}
      LDAP_ENCRYPTION_METHOD: ${LDAP_ENCRYPTION_METHOD:-none}
      LDAP_USER_BASE_DN: ${LDAP_USER_BASE_DN:-}
      LDAP_USERNAME_ATTRIBUTE: ${LDAP_USERNAME_ATTRIBUTE:-uid}
      LDAP_GROUP_BASE_DN: ${LDAP_GROUP_BASE_DN:-}
      LDAP_SEARCH_BIND_DN: ${LDAP_SEARCH_BIND_DN:-}
      LDAP_SEARCH_BIND_PASSWORD: ${LDAP_SEARCH_BIND_PASSWORD:-}
      LDAP_CONFIG_BASE_DN: ${LDAP_CONFIG_BASE_DN:-}
      LDAP_MAX_SEARCH_RESULTS: ${LDAP_MAX_SEARCH_RESULTS:-1000}
      LDAP_OPERATION_TIMEOUT: ${LDAP_OPERATION_TIMEOUT:-30}
      LDAP_FOLLOW_REFERRALS: ${LDAP_FOLLOW_REFERRALS:-false}
      LDAP_USER_SEARCH_FILTER: ${LDAP_USER_SEARCH_FILTER:-}
      LDAP_GROUP_NAME_ATTRIBUTE: ${LDAP_GROUP_NAME_ATTRIBUTE:-cn}
      LDAP_MEMBER_ATTRIBUTE: ${LDAP_MEMBER_ATTRIBUTE:-member}
      
      # Configuration OpenID (optionnel)
      OPENID_AUTHORIZATION_ENDPOINT: ${OPENID_AUTHORIZATION_ENDPOINT:-}
      OPENID_TOKEN_ENDPOINT: ${OPENID_TOKEN_ENDPOINT:-}
      OPENID_JWKS_ENDPOINT: ${OPENID_JWKS_ENDPOINT:-}
      OPENID_ISSUER: ${OPENID_ISSUER:-}
      OPENID_CLIENT_ID: ${OPENID_CLIENT_ID:-}
      OPENID_CLIENT_SECRET: ${OPENID_CLIENT_SECRET:-}
      OPENID_REDIRECT_URI: ${OPENID_REDIRECT_URI:-}
      OPENID_SCOPE: ${OPENID_SCOPE:-openid profile email}
      OPENID_USERNAME_CLAIM_TYPE: ${OPENID_USERNAME_CLAIM_TYPE:-preferred_username}
      OPENID_GROUPS_CLAIM_TYPE: ${OPENID_GROUPS_CLAIM_TYPE:-groups}
      OPENID_MAX_TOKEN_VALIDITY: ${OPENID_MAX_TOKEN_VALIDITY:-300}
      OPENID_ALLOWED_CLOCK_SKEW: ${OPENID_ALLOWED_CLOCK_SKEW:-30}
      
      # Configuration des logs
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ENABLE_DEBUG: ${ENABLE_DEBUG:-false}
      LOG_FILE: ${LOG_FILE:-/var/log/guacamole/guacamole.log}
      LOG_MAX_FILE_SIZE: ${LOG_MAX_FILE_SIZE:-10MB}
      LOG_MAX_HISTORY: ${LOG_MAX_HISTORY:-7}
      
      # Paramètres JVM
      JVM_HEAP_MIN: ${JVM_HEAP_MIN:-256m}
      JVM_HEAP_MAX: ${JVM_HEAP_MAX:-1g}
      JVM_METASPACE_SIZE: ${JVM_METASPACE_SIZE:-128m}
      JVM_MAX_METASPACE_SIZE: ${JVM_MAX_METASPACE_SIZE:-256m}
      JVM_DIRECT_MEMORY_SIZE: ${JVM_DIRECT_MEMORY_SIZE:-}
      JAVA_OPTS: ${JAVA_OPTS:-}
      
      # Configuration JMX
      ENABLE_JMX: ${ENABLE_JMX:-false}
      JMX_PORT: ${JMX_PORT:-9090}
      JMX_HOSTNAME: ${JMX_HOSTNAME:-localhost}
      JMX_AUTHENTICATE: ${JMX_AUTHENTICATE:-false}
      JMX_SSL: ${JMX_SSL:-false}
      JMX_USERNAME: ${JMX_USERNAME:-admin}
      JMX_PASSWORD: ${JMX_PASSWORD:-admin}
      
      # Configuration Tomcat
      TOMCAT_MAX_THREADS: ${TOMCAT_MAX_THREADS:-200}
      TOMCAT_MIN_SPARE_THREADS: ${TOMCAT_MIN_SPARE_THREADS:-10}
      TOMCAT_CONNECTION_TIMEOUT: ${TOMCAT_CONNECTION_TIMEOUT:-20000}
      TOMCAT_MAX_CONNECTIONS: ${TOMCAT_MAX_CONNECTIONS:-10000}
      TOMCAT_ACCEPT_COUNT: ${TOMCAT_ACCEPT_COUNT:-100}
      TOMCAT_MAX_HTTP_HEADER_SIZE: ${TOMCAT_MAX_HTTP_HEADER_SIZE:-8192}
      TOMCAT_COMPRESSION: ${TOMCAT_COMPRESSION:-on}
      TOMCAT_COMPRESSION_MIN_SIZE: ${TOMCAT_COMPRESSION_MIN_SIZE:-2048}
      
      # Configuration Guacamole
      GUACD_HOSTNAME: guacd
      GUACD_PORT: 4822
      API_SESSION_TIMEOUT: ${API_SESSION_TIMEOUT:-60}
      EXTENSION_PRIORITY: ${EXTENSION_PRIORITY:-ldap,openid}
      ENABLE_CLIPBOARD: ${ENABLE_CLIPBOARD:-true}
      ENABLE_PRINTING: ${ENABLE_PRINTING:-true}
      ENABLE_DRIVE: ${ENABLE_DRIVE:-true}
      MAX_CLIPBOARD_LENGTH: ${MAX_CLIPBOARD_LENGTH:-262144}
      
      # Configuration de sécurité
      ENABLE_ENVIRONMENT_PROPERTIES: ${ENABLE_ENVIRONMENT_PROPERTIES:-true}
      SKIP_IF_UNAVAILABLE: ${SKIP_IF_UNAVAILABLE:-postgresql,ldap,openid}
      ALLOWED_LANGUAGES: ${ALLOWED_LANGUAGES:-en,fr,de,es}
      ENABLE_WEBSOCKET: ${ENABLE_WEBSOCKET:-true}
      ENABLE_HTTP_AUTH: ${ENABLE_HTTP_AUTH:-false}
      ENABLE_TOTP: ${ENABLE_TOTP:-false}
      ENABLE_DUO: ${ENABLE_DUO:-false}
      
      # Configuration cache
      CACHE_ENABLED: ${CACHE_ENABLED:-true}
      CACHE_MAX_SIZE: ${CACHE_MAX_SIZE:-10000}
      CACHE_TTL: ${CACHE_TTL:-600}
      
    volumes:
      - guacamole_home:/etc/guacamole
      - guacamole_logs:/var/log/guacamole
      - ./extensions:/opt/guacamole/extensions-custom:ro
    networks:
      - guacamole_network
    ports:
      - "8080:8080"
      - "9090:9090"  # Port JMX si activé
      - "5005:5005"  # Port debug si activé
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/guacamole/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Service de monitoring (optionnel)
  prometheus:
    image: prom/prometheus:latest
    container_name: guacamole-prometheus
    restart: unless-stopped
    profiles:
      - monitoring
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - guacamole_network
    ports:
      - "9092:9090"

  # Grafana pour visualisation (optionnel)
  grafana:
    image: grafana/grafana:latest
    container_name: guacamole-grafana
    restart: unless-stopped
    profiles:
      - monitoring
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - guacamole_network
    ports:
      - "3000:3000"

  # Service LDAP de test (optionnel)
  openldap:
    image: osixia/openldap:latest
    container_name: guacamole-ldap
    restart: unless-stopped
    profiles:
      - ldap-test
    environment:
      LDAP_ORGANISATION: "Example Corp"
      LDAP_DOMAIN: "example.com"
      LDAP_ADMIN_PASSWORD: ${LDAP_ADMIN_PASSWORD:-admin}
      LDAP_CONFIG_PASSWORD: ${LDAP_CONFIG_PASSWORD:-config}
      LDAP_TLS: "false"
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
    networks:
      - guacamole_network
    ports:
      - "389:389"
      - "636:636"

  # Interface LDAP (optionnel)
  phpldapadmin:
    image: osixia/phpldapadmin:latest
    container_name: guacamole-phpldapadmin
    restart: unless-stopped
    profiles:
      - ldap-test
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: "openldap"
      PHPLDAPADMIN_HTTPS: "false"
    networks:
      - guacamole_network
    ports:
      - "8090:80"

networks:
  guacamole_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

volumes:
  postgres_data:
  guacd_drive:
  guacd_record:
  guacamole_home:
  guacamole_logs:
  prometheus_data:
  grafana_data:
  ldap_data:
  ldap_config: